name: Terraform Automation  
  
on:  
  push:  
    branches:  
      - main  
  pull_request:  
    branches:  
      - main  
  workflow_dispatch:  
    inputs:  
      terraform_action:  
        description: 'Terraform action to execute (apply/destroy)'  
        required: true  
        default: 'apply'  
  
jobs:  
  terraform:  
    runs-on: ubuntu-latest  
    steps:  
      # Step 1: Checkout the repository code  
      - name: Checkout code  
        uses: actions/checkout@v3  
  
      # Step 2: Set up Terraform CLI  
      - name: Set up Terraform  
        uses: hashicorp/setup-terraform@v2  
        with:  
          terraform_version: 1.5.7 # Specify your Terraform version  
  
      # Step 3: Configure AWS credentials  
      - name: Configure AWS Credentials  
        uses: aws-actions/configure-aws-credentials@v2  
        with:  
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}  
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}  
          aws-region: ${{ secrets.AWS_REGION }}  
  
      # Step 4: Initialize Terraform  
      - name: Terraform Init  
        run: terraform init  
  
      # Step 5: Terraform Plan  
      - name: Terraform Plan  
        env:  
          TF_VAR_ami_id: ${{ secrets.AMI_ID }}  
          TF_VAR_instance_type: ${{ secrets.INSTANCE_TYPE }}  
          TF_VAR_key_name: ${{ secrets.KEY_NAME }}  
          TF_VAR_db_name: ${{ secrets.DB_NAME }}  
          TF_VAR_db_user: ${{ secrets.DB_USER }}  
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}  
          TF_VAR_db_host: ${{ secrets.DB_HOST }}  
          TF_VAR_db_port: ${{ secrets.DB_PORT }}  
        run: terraform plan -out=plan.tfplan  
  
      # Step 6: Apply or Destroy Terraform  
      - name: Terraform Apply/Destroy  
        env:  
          TF_VAR_ami_id: ${{ secrets.AMI_ID }}  
          TF_VAR_instance_type: ${{ secrets.INSTANCE_TYPE }}  
          TF_VAR_key_name: ${{ secrets.KEY_NAME }}  
          TF_VAR_db_name: ${{ secrets.DB_NAME }}  
          TF_VAR_db_user: ${{ secrets.DB_USER }}  
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}  
          TF_VAR_db_host: ${{ secrets.DB_HOST }}  
          TF_VAR_db_port: ${{ secrets.DB_PORT }}  
        run: |  
          if [ "${{ github.event.inputs.terraform_action }}" == "apply" ]; then  
            echo "Running terraform apply..."  
            terraform apply -auto-approve plan.tfplan  
          elif [ "${{ github.event.inputs.terraform_action }}" == "destroy" ]; then  
            echo "Running terraform destroy..."  
            terraform destroy -auto-approve  
          else  
            echo "Invalid action. Please specify 'apply' or 'destroy'."  
            exit 1  
          fi  
